name: Branch & commit naming check

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, edited, reopened]

jobs:
  check-naming:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check branch name and last commit
        run: |
          # Для push github.ref_name, для PR - github.head_ref
          BRANCH="${{ github.head_ref || github.ref_name }}"
          echo "Branch: $BRANCH"

          # Разрешённые типы и формат:
          # type/123-short-title/Имя (Имя можно опустить)
          if echo "$BRANCH" | grep -Eq '^(feature|bugfix|docs|refactor|content|balance|ci)/[0-9]+-[A-Za-z0-9-]+(/[A-Za-z0-9_-]+)?$'; then
            echo "✅ Название ветки в порядке"
          else
            echo "::error:: Неправильное имя ветки: $BRANCH"
            echo "Ожидается формат: bugfix/125-fix-crash/Имя или feature/123-short-title/Имя"
            exit 1  
          fi

          LAST_COMMIT_MSG="$(git log -1 --pretty=%B | head -n1)"
          echo "Last commit message: $LAST_COMMIT_MSG"
          
          if [[ "$LAST_COMMIT_MSG" =~ #[0-9]+ ]]; then
            echo "✅ В сообщении коммита есть номер задачи вида '#123'."
          else
            echo "::error::В сообщении коммита нет номера задачи вида '#123'."
            exit 1
          fi
